<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

  <title>ä¸å‹•ç”£ãƒãƒƒãƒ—</title>
  <style>
    #map { height: 100vh; width: 100%; }

    select#categoryFilter {
      width: 100%;
      box-sizing: border-box;
      font-size: 18px;
      padding: 10px 12px;
      border-radius: 4px;
      background-color: #fff;
      border: 1px solid #ccc;
      appearance: none;
      background-image: url("data:image/svg+xml,...");
      background-repeat: no-repeat;
      background-position: right 20px center;
      background-size: 24px;
    }

    #categoryBar {
      position: absolute;
      top: 70px;
      left: 10px;
      right: 10px;
      z-index: 999;
      background: white;
      padding: 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      border-radius: 8px;
    }

    #cityFilterContainer { margin-top: 10px; }

    .info-window {
      font-size: inherit;
      line-height: inherit;
      max-width: 300px;
      padding: 12px;
      background-color: white;
      border: 2px solid #ccc;
    }

    @media (max-width: 768px) {
      .info-window, .info-window * {
        font-size: 4vw !important;
        line-height: 2.2em !important;
      }
      .info-window {
        max-width: 98vw;
        padding: 24px;
      }
    }
  </style>

  <script>
    let map;
    let allMarkers = [];
    let currentInfoWindow = null;
    let fullData = [];
    const isMobile = window.matchMedia("(max-width: 768px)").matches;

    const iconMap = {
      "åœŸåœ°": "http://maps.google.com/mapfiles/ms/icons/green-dot.png",
      "æˆ¸å»ºã¦": "http://maps.google.com/mapfiles/ms/icons/blue-dot.png",
      "ãƒãƒ³ã‚·ãƒ§ãƒ³": "http://maps.google.com/mapfiles/ms/icons/purple-dot.png",
      "å¤–äººä½å®…": "http://maps.google.com/mapfiles/ms/icons/yellow-dot.png",
      "æ°‘æ³Šé‹å–¶ç‰©ä»¶": "http://maps.google.com/mapfiles/ms/icons/orange-dot.png",
      "ãã®ä»–": "http://maps.google.com/mapfiles/ms/icons/red-dot.png"
    };

    async function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 26.2124, lng: 127.6809 },
        zoom: isMobile ? 14 : 9,
      });

      try {
        const response = await fetch('https://script.google.com/macros/s/AKfycbwuYJQ7Oxjh0cyDDjmoEjFBhSbmUSZ1cO7uw0ONdnWojfQD36L8IVrMAa8O07haB2_Yqw/exec');
        fullData = await response.json();

        const categoryFilter = document.getElementById('categoryFilter');
        const cityFilterContainer = document.getElementById('cityFilterContainer');

        const categories = [...new Set(fullData.map(item => item.sheet))].filter(Boolean);
        categoryFilter.innerHTML = '<option value="">ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>' +
          categories.map(cat => `<option value="${cat}">${cat}</option>`).join('');

        categoryFilter.addEventListener('change', (e) => {
          const selectedCategory = e.target.value;
          if (!selectedCategory) return;

          const cityOrder = [
            "åè­·å¸‚", "æ©ç´æ‘", "é‡‘æ­¦ç”º", "å®œé‡åº§æ‘", "æœ¬éƒ¨ç”º", "ä»Šå¸°ä»æ‘", "å¤§å®œå‘³æ‘", "å›½é ­æ‘", "æ±æ‘",
            "æ²–ç¸„å¸‚", "æµ¦æ·»å¸‚", "å®œé‡æ¹¾å¸‚", "ã†ã‚‹ã¾å¸‚", "èª­è°·æ‘", "è¥¿åŸç”º", "åŒ—è°·ç”º", "ä¸­åŸæ‘", "åŒ—ä¸­åŸæ‘", "å˜‰æ‰‹ç´ç”º",
            "é‚£è¦‡å¸‚", "è±Šè¦‹åŸå¸‚", "ç³¸æº€å¸‚", "å—é¢¨åŸç”º", "å—åŸå¸‚", "ä¸é‚£åŸç”º", "å…«é‡ç€¬ç”º",
            "çŸ³å£å¸‚", "å®®å¤å³¶å¸‚", "ãã®ä»–"
          ];

          const cities = [...new Set(fullData.filter(d => d.sheet === selectedCategory).map(d => d.city || 'æœªè¨­å®š'))];
          cities.sort((a, b) => {
            const indexA = cityOrder.indexOf(a);
            const indexB = cityOrder.indexOf(b);
            return (indexA === -1 ? 999 : indexA) - (indexB === -1 ? 999 : indexB);
          });

          cityFilterContainer.innerHTML = '<strong>å¸‚ã‚’é¸æŠï¼š</strong><br>';

          const allBtn = document.createElement('button');
          allBtn.textContent = 'ã™ã¹ã¦';
          styleButton(allBtn);
          allBtn.style.background = '#e0e0e0';
          allBtn.onclick = () => renderMarkers(selectedCategory, '');
          cityFilterContainer.appendChild(allBtn);

          cities.forEach(city => {
            const btn = document.createElement('button');
            btn.textContent = city;
            styleButton(btn);
            btn.onclick = () => renderMarkers(selectedCategory, city);
            cityFilterContainer.appendChild(btn);
          });

          renderMarkers(selectedCategory, '');
        });

      } catch (err) {
        console.error("ãƒ‡ãƒ¼ã‚¿å–å¾—ã‚¨ãƒ©ãƒ¼:", err);
      }
    }

    function styleButton(btn) {
      btn.style.margin = '4px';
      btn.style.padding = '6px 12px';
      btn.style.border = '1px solid #aaa';
      btn.style.borderRadius = '4px';
      btn.style.background = '#f5f5f5';
      btn.style.cursor = 'pointer';
    }

    function renderMarkers(category, city) {
      allMarkers.forEach(marker => marker.setMap(null));
      allMarkers = [];

      const filtered = fullData.filter(item =>
        item.sheet === category && (!city || item.city === city)
      );

      filtered.forEach(item => {
        const marker = new google.maps.Marker({
          position: { lat: parseFloat(item.lat), lng: parseFloat(item.lng) },
          map,
          icon: {
            url: iconMap[item.sheet] || iconMap["ãã®ä»–"],
            scaledSize: new google.maps.Size(32, 32)
          },
          title: item.name,
        });

        const content = `
          <div class="info-window">
    <div><strong>ã€${item.sheet}ã€‘</strong></div>
    <div>${item.name}</div>
    <div>ä¾¡æ ¼ï¼š${item.price || '---'} ä¸‡å††</div>
    <div>åªå˜ä¾¡ï¼š${item.unit || '---'}ä¸‡å††</div> <!-- Fåˆ— -->
    <div>å‚™è€ƒï¼š${item.note || '---'}</div>    <!-- Jåˆ— -->
    ${item.pdf ? `<div><a href="${item.pdf}" target="_blank">ğŸ“„ PDFã‚’è¦‹ã‚‹</a></div>` : ''}
  </div>
        `;

        const infowindow = new google.maps.InfoWindow({ content });

        marker.addListener("click", () => {
          if (currentInfoWindow) currentInfoWindow.close();
          infowindow.open({ anchor: marker, map });
          currentInfoWindow = infowindow;
        });

        google.maps.event.addListenerOnce(infowindow, 'domready', () => {
          if (isMobile) {
            const iwEls = document.getElementsByClassName('info-window');
            for (let el of iwEls) {
              el.style.fontSize = '38px';
              el.style.lineHeight = '2.2em';
              const children = el.querySelectorAll('*');
              children.forEach(child => {
                child.style.fontSize = '38px';
                child.style.lineHeight = '2.2em';
              });
            }
          }
        });

        allMarkers.push(marker);
      });
    }
  </script>
</head>
<body>
  <div id="categoryBar">
    <select id="categoryFilter">
      <option>ã‚«ãƒ†ã‚´ãƒªã‚’é¸æŠ</option>
    </select>
    <div id="cityFilterContainer"></div>
  </div>
  <div id="map"></div>
  <script
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCYQnbLmcGyA0-2U5eEuLxYYeSDEn9z_nA&callback=initMap"
    async defer
  ></script>
</body>
</html>
